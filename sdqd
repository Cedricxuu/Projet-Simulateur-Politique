import ollama
from ollama import Client
import time
import re  # pour l'extraction robuste

client = Client(host='http://localhost:11434')
mort = False
tour = 1  # Variable pour suivre le numÃ©ro du tour

# Jauges
etat = {
    "Bonheur": 50,
    "Environnement": 50,
    "Ã‰conomie": 50,
}
variation = {
    "Bonheur": 0,
    "Environnement": 0,
    "Ã‰conomie": 0,
}

def generer_probleme():
    """Demande Ã  l'IA de gÃ©nÃ©rer un problÃ¨me politique avec des impacts cachÃ©s pour chaque solution."""
    response = client.chat(
        model="mistral",
        messages=[
            {
                "role": "system",
                "content": 
                """RÃ¨gles Ã  respecter obligatoirement :    
                Pas d'intro/transition.
                Toute les situations se place uniquement en France.
                Tu dois gÃ©nÃ©rer un problÃ¨me politique ou Ã©conomique avec 3 solutions distinctes.
                
                TRÃˆS IMPORTANT : Pour chaque solution, tu dois gÃ©nÃ©rer des impacts diffÃ©rents sur les jauges:
                - "Bonheur" (valeur entre -10 et +10)
                - "Ã‰conomie" (valeur entre -10 et +10)
                - "Environnement" (valeur entre -10 et +10)
                
                Ces impacts doivent Ãªtre logiquement liÃ©s aux solutions proposÃ©es.
                
                OBLIGATOIRE : Inclure ces impacts dans une section cachÃ©e aprÃ¨s les solutions, format:
                
                ### Impacts ###
                [1]: Bonheur:{}, Ã‰conomie:{}, Environnement:{}
                [2]: Bonheur:{}, Ã‰conomie:{}, Environnement:{}
                [3]: Bonheur:{}, Ã‰conomie:{}, Environnement:{}
                
                Les valeurs DOIVENT Ãªtre diffÃ©rentes pour chaque option.
                
                Ã‰crire en franÃ§ais exclusivement.
              
                Format strict de la rÃ©ponse visible pour l'utilisateur : 
                Une premiÃ¨re ligne dÃ©crivant le problÃ¨me courtement
            
                [1] : [description de la premiÃ¨re solution en une phrase ]
                [2] : [description de la seconde solution en une phrase ]
                [3] : [description de la troisiÃ¨me solution en une phrase]
                """
            },
            {
                "role": "user",
                "content": "PrÃ©sente un problÃ¨me politique/Ã©conomique qui pourrait survenir et ses solutions."
            }
        ],
        options={
            'temperature': 0.8
        }
    )
    return response['message']['content']


def extraire_impact(texte_complet, choix):
    """Extrait les impacts mÃªme si l'IA ne suit pas parfaitement le format."""
    try:
        pattern = r"\[{}\]:.*?Bonheur\s*:\s*(-?\d+).*?Ã‰conomie\s*:\s*(-?\d+).*?Environnement\s*:\s*(-?\d+)".format(choix)
        match = re.search(pattern, texte_complet, re.DOTALL)
        if match:
            bonheur = int(match.group(1))
            economie = int(match.group(2))
            environnement = int(match.group(3))
            return {
                "Bonheur": bonheur,
                "Ã‰conomie": economie,
                "Environnement": environnement
            }
        else:
            print("[âš ï¸] Impacts non trouvÃ©s pour le choix", choix, "- valeurs par dÃ©faut utilisÃ©es.")
            return {"Bonheur": 0, "Ã‰conomie": 0, "Environnement": 0}
    except Exception as e:
        print(f"[Erreur] ProblÃ¨me d'extraction des impacts : {e}")
        return {"Bonheur": 0, "Ã‰conomie": 0, "Environnement": 0}


def ajuster_jauges(impacts):
    """Ajuste les jauges en fonction des impacts extraits."""
    for jauge, valeur in impacts.items():
        if jauge in etat:
            variation[jauge] = valeur
            etat[jauge] += valeur
            etat[jauge] = max(0, min(100, etat[jauge]))


def afficher_probleme(texte_complet):
    """Affiche uniquement la partie visible du problÃ¨me (sans les impacts)."""
    if "### Impacts ###" in texte_complet:
        partie_visible = texte_complet.split("### Impacts ###")[0].strip()
        print(partie_visible)
    else:
        print(texte_complet)


def afficher_situation():
    """Affiche la situation actuelle avec les variations depuis le dernier tour."""
    print("\nðŸ“Š Ã‰TAT DU PAYS :")
    for nom, valeur in etat.items():
        barres = int(valeur / 10)
        var = variation[nom]
        var_text = ""
        if var > 0:
            var_text = f" (â†‘ +{var})"
        elif var < 0:
            var_text = f" (â†“ {var})"
        print(f"{nom:12} : [{'#' * barres}{'-' * (10 - barres)}] {valeur}/100{var_text}")
    
    for key in variation:
        variation[key] = 0
        
    if any(valeur <= 0 for valeur in etat.values()):
        print("\nðŸ’¥ Une des structures du pays s'effondre. GAME OVER.")
        return True
    return False


def intro_jeu():
    print("\n" + "="*60)
    print("ðŸ›ï¸  SIMULATEUR DE GOUVERNANCE POLITIQUE  ðŸ›ï¸")
    print("="*60)
    print("\nVous Ãªtes Ã  la tÃªte d'un pays et devez prendre des dÃ©cisions difficiles.")
    print("Chaque choix aura des consÃ©quences sur le bonheur de la population,")
    print("l'Ã©conomie et l'environnement. Maintenez l'Ã©quilibre pour survivre!")
    print("\nObjectif: EmpÃªcher qu'une jauge tombe Ã  zÃ©ro.")
    print("="*60)


# Programme principal
intro_jeu()
print(f"\nðŸ”„ Tour nÂ°{tour}")

while not mort:
    texte_complet = generer_probleme()
    afficher_probleme(texte_complet)
    
    try:
        choix = int(input("\nRÃ©agissez en choisissant une solution (1, 2 ou 3) : "))
        if choix not in [1, 2, 3]:
            print("Choix invalide. Veuillez entrer 1, 2 ou 3.")
            continue
        
        impacts = extraire_impact(texte_complet, choix)
        ajuster_jauges(impacts)
        
        print(f"\nVous avez choisi la solution {choix}. Les consÃ©quences se manifestent au prochain tour.")
        time.sleep(1.5)
        
        tour += 1
        print(f"\nðŸ”„ Tour nÂ°{tour}")
        mort = afficher_situation()
        
    except ValueError:
        print("EntrÃ©e invalide. Veuillez entrer un nombre entre 1 et 3.")

print("\nMerci d'avoir jouÃ©!")
